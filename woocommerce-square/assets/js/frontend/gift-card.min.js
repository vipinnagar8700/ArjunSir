"use strict";function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg);var value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{Promise.resolve(value).then(_next,_throw)}}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise(function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(undefined)})}}jQuery(document).ready($=>{class WC_Square_Gift_Card_Handler{constructor(args){this.applicationId=args.applicationId;this.locationId=args.locationId;this.giftCard=null;this.applyGiftCardNonce=args.applyGiftCardNonce;this.removeGiftCardText=args.removeGiftCardText;this.applyDiffGiftCard=args.applyDiffGiftCard;this.splitPaymentQuestion=args.splitPaymentQuestion;this.splitPaymentMessage=args.splitPaymentMessage;this.isValidPage=args.isValidPage;this.reviewOrderTable=$(".woocommerce-checkout-review-order-table");this.payments=window.Square?window.Square.payments(this.applicationId,this.locationId):false;this.handleSingProductPage();$(document.body).on("updated_checkout",this.init.bind(this))}init(e,data){var _this=this;return _asyncToGenerator(function*(){if(!_this.payments){return}_this.renderGiftCardHtml(data.fragments);_this.initVariables();_this.block_ui(_this.giftCardAppWrapper);$(document.body).on("update_checkout",()=>{if(_this.hiddenFieldsEl){_this.hiddenFieldsEl.find("input[name=\"payment_method\"]").remove()}_this.block_ui(_this.giftCardAppWrapper)});try{_this.giftCard=yield _this.initializeGiftCard(_this.payments)}catch(e){console.error("Initializing Gift Card failed",e)}_this.giftCardAppWrapper.unblock();_this.giftCardBtnEl.on("click",_asyncToGenerator(function*(){yield _this.applyGiftCardHandler(_this.giftCard)}));_this.splitPaymentEl.on("click",_this.onSplitTotal.bind(_this));if(_this.giftCard){_this.giftCard.addEventListener("errorClassAdded",()=>{_this.toggleGiftCardApplyButton(true)});_this.giftCard.addEventListener("errorClassRemoved",()=>{_this.toggleGiftCardApplyButton(false)})}_this.removeGiftCardEl.on("click",_this.onRemoveGiftCard.bind(_this))})()}toggleDisabledAttribute(){var formWrapper=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var status=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;if(!formWrapper){return}formWrapper.find("input, textarea").each((index,element)=>{$(element).attr("disabled",status)})}handleSingProductPage(){$("input[name=\"square-gift-card-buying-option\"]").on("click",e=>{var newWrapper=$("[data-square-gift-card-activity=\"new\"]");var loadWrapper=$("[data-square-gift-card-activity=\"load\"]");if("new"===$(e.target).val()){newWrapper.show();loadWrapper.hide();this.toggleDisabledAttribute(newWrapper);this.toggleDisabledAttribute(loadWrapper,true)}else{loadWrapper.show();newWrapper.hide();this.toggleDisabledAttribute(loadWrapper);this.toggleDisabledAttribute(newWrapper,true)}})}initVariables(){this.giftCardWrapperEl=$("#square-gift-card-fields-input");this.giftCardAppWrapper=$("#square-gift-card-wrapper");this.giftCardBtnEl=$("#square-gift-card-apply-btn");this.removeGiftCardEl=$("#square-gift-card-remove");this.splitPaymentEl=$("#square-split-payment")}toggleGiftCardApplyButton(){var isDisabled=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;this.giftCardBtnEl.prop("disabled",isDisabled)}initializeGiftCard(){var _arguments=arguments,_this2=this;return _asyncToGenerator(function*(){var payments=_arguments.length>0&&_arguments[0]!==undefined?_arguments[0]:null;if(!payments){return}var giftCard=yield payments.giftCard();yield giftCard.attach(_this2.giftCardWrapperEl[0]);return giftCard})()}renderGiftCardHtml(fragments){$("#square-gift-card-wrapper").remove();$("#square-gift-card-split-details").remove();$(".woocommerce-checkout-review-order-table").after(fragments[".woocommerce-square-gift-card-html"]);this.hiddenFieldsEl=$("#square-gift-card-hidden-fields");if(this.hiddenFieldsEl&&fragments["has-balance"]){this.hiddenFieldsEl.append("<input name=\"payment_method\" type=\"hidden\" value=\"square_credit_card\" />")}else{this.hiddenFieldsEl.find("input[name=\"payment_method\"]").remove()}}applyGiftCardHandler(giftCard){var _this3=this;return _asyncToGenerator(function*(){_this3.block_ui(_this3.giftCardAppWrapper);var token;try{token=yield _this3.tokenize(giftCard)}catch(_unused){giftCard.setError("giftCardNumber");_this3.giftCardAppWrapper.unblock()}if(!token){return}yield _this3.checkGiftCardBalance(token);$(document.body).trigger("update_checkout")})()}tokenize(giftCard){return _asyncToGenerator(function*(){var tokenResult=yield giftCard.tokenize();if(tokenResult.status==="OK"){return tokenResult.token}else{return false}})()}checkGiftCardBalance(){var _arguments2=arguments,_this4=this;return _asyncToGenerator(function*(){var token=_arguments2.length>0&&_arguments2[0]!==undefined?_arguments2[0]:null;var formData=new FormData;formData.append("token",token);formData.append("action","wc_square_check_gift_card_balance");formData.append("security",_this4.applyGiftCardNonce);var response=yield fetch(woocommerce_params.ajax_url,{method:"POST",body:formData});if(200!==response.status){return}return response.json()})()}onRemoveGiftCard(event){var _this5=this;return _asyncToGenerator(function*(){event.preventDefault();if(_this5.giftCard){var giftCardDestroyed=yield _this5.giftCard.destroy();if(giftCardDestroyed){_this5.giftCard=yield _this5.initializeGiftCard(_this5.payments)}}var formData=new FormData;formData.append("action","wc_square_gift_card_remove");formData.append("security",_this5.applyGiftCardNonce);var response=yield fetch(woocommerce_params.ajax_url,{method:"POST",body:formData});if(200!==response.status){return}response=yield response.json();if(response.success){$(document.body).trigger("update_checkout")}})()}onSplitTotal(event){var _this6=this;return _asyncToGenerator(function*(){event.preventDefault();var formData=new FormData;formData.append("action","wc_square_split_payments");formData.append("security",_this6.applyGiftCardNonce);var response=yield fetch(woocommerce_params.ajax_url,{method:"POST",body:formData});if(200!==response.status){return}response=yield response.json();if(response.success){$(document.body).trigger("update_checkout")}})()}block_ui(){var element=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;if(!element){return}element.block({message:null,overlayCSS:{background:"#fff",opacity:0.6}})}}window.WC_Square_Gift_Card_Handler=WC_Square_Gift_Card_Handler});
