"use strict";function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg);var value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{Promise.resolve(value).then(_next,_throw)}}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise(function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(undefined)})}}jQuery(document).ready($=>{class WC_Square_Cash_App_Pay_Handler{constructor(args){this.args=args;this.payment_request=args.payment_request||{};this.isPayForOrderPage=args.is_pay_for_order_page;this.orderId=args.order_id;this.id_dasherized=args.gateway_id_dasherized;this.buttonStyles=args.button_styles;this.referenceId=this.reference_id;this.cashAppButton="#wc-square-cash-app";this.settingUp=false;this.build_cash_app();this.attach_page_events()}build_cash_app(){if(this.settingUp||$(document).find(this.cashAppButton).length===0){return}this.settingUp=true;this.block_ui();return this.get_payment_request().then(response=>{var oldPaymentRequest=JSON.stringify(this.payment_request);this.payment_request=JSON.parse(response);this.total_amount=this.payment_request.total.amount;if(this.has_payment_nonce()&&$("#wc-square-cash-app #cash_app_pay_v1_element").length&&JSON.stringify(this.payment_request)===oldPaymentRequest){this.settingUp=false;this.unblock_ui();return}$(this.cashAppButton).hide();$("input[name=wc-".concat(this.id_dasherized,"-payment-nonce]")).val("");return this.load_cash_app_form()},message=>{this.log("[Square Cash App Pay] Could not build payment request. "+message,"error");$(this.cashAppButton).hide();this.unblock_ui();this.settingUp=false})}attach_page_events(){$(document.body).on("updated_checkout",()=>this.build_cash_app());$(document.body).on("payment_method_selected",()=>this.toggle_order_button())}load_cash_app_form(){var _this=this;return _asyncToGenerator(function*(){_this.log("[Square Cash App Pay] Building Cash App Pay");var{applicationId,locationId}=_this.get_form_params();_this.payments=window.Square.payments(applicationId,locationId);yield _this.initializeCashAppPay();_this.unblock_ui();_this.log("[Square Cash App Pay] Square Cash App Pay Button Loaded");_this.settingUp=false})()}initializeCashAppPay(){var _this2=this;return _asyncToGenerator(function*(){if(!_this2.payments){return}var paymentRequest=_this2.payments.paymentRequest(_this2.create_payment_request());if(_this2.cashAppPay){yield _this2.cashAppPay.destroy()}_this2.cashAppPay=yield _this2.payments.cashAppPay(paymentRequest,{redirectURL:window.location.href,referenceId:_this2.referenceId});yield _this2.cashAppPay.attach("#wc-square-cash-app",_this2.buttonStyles);_this2.cashAppPay.addEventListener("ontokenization",event=>_this2.handleCashAppPaymentResponse(event));_this2.toggle_order_button();if(_this2.cashAppPay){$(_this2.cashAppButton).show()}})()}handleCashAppPaymentResponse(event){this.blockedForm=this.blockForm();var{tokenResult,error}=event.detail;this.log_data(event.detail,"response");if(error){this.render_errors([error.message]);if(this.blockedForm){this.blockedForm.unblock()}}else if(tokenResult.status==="OK"){var nonce=tokenResult.token;if(!nonce){if(this.blockedForm){this.blockedForm.unblock()}return this.render_errors(this.args.general_error)}$("input[name=wc-".concat(this.id_dasherized,"-payment-nonce]")).val(nonce);if(!$("input#payment_method_square_cash_app_pay").is(":checked")){$("input#payment_method_square_cash_app_pay").trigger("click");$("input#payment_method_square_cash_app_pay").attr("checked",true)}this.toggle_order_button();if($("#order_review").length){$("#order_review").trigger("submit")}else{$("form.checkout").trigger("submit")}}else{if(this.blockedForm){this.blockedForm.unblock()}this.build_cash_app()}}blockForm(){var checkoutForm=$("form.checkout, form#order_review");checkoutForm.block({message:null,overlayCSS:{background:"#fff",opacity:0.6}});return checkoutForm}get_form_params(){var params={applicationId:this.args.application_id,locationId:this.args.location_id};return params}create_payment_request(){return this.payment_request}get_payment_request(){return new Promise((resolve,reject)=>{var data={security:this.args.payment_request_nonce,is_pay_for_order_page:this.isPayForOrderPage,order_id:this.orderId,check_for_giftcard:!this.isPayForOrderPage};$.post(this.get_ajax_url("get_payment_request"),data,response=>{if(response.success){return resolve(response.data)}return reject(response.data)})})}get_ajax_url(request){return this.args.ajax_url.replace("%%endpoint%%","square_cash_app_pay_"+request)}render_errors_html(errors_html){$(".woocommerce-error, .woocommerce-message").remove();var element=$("form[name=\"checkout\"]");element.before(errors_html);if(this.blockedForm){this.blockedForm.unblock()}$("html, body").animate({scrollTop:element.offset().top-100},1000)}render_errors(errors){var error_message_html="<ul class=\"woocommerce-error\"><li>"+errors.join("</li><li>")+"</li></ul>";this.render_errors_html(error_message_html)}block_ui(){$(".woocommerce-checkout-payment, #payment").block({message:null,overlayCSS:{background:"#fff",opacity:0.6}})}unblock_ui(){$(".woocommerce-checkout-payment, #payment").unblock()}log_data(data,type){if(!this.args.logging_enabled){return}var ajax_data={security:this.args.ajax_log_nonce,type,data};$.ajax({url:this.get_ajax_url("log_js_data"),data:ajax_data})}log(message){var type=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"notice";if(!this.args.checkout_logging){return}if(type==="error"){return console.error(message)}return console.log(message)}has_payment_nonce(){return $("input[name=wc-".concat(this.id_dasherized,"-payment-nonce]")).val()}get_selected_gateway_id(){return $("form.checkout, form#order_review").find("input[name=payment_method]:checked").val()}toggle_order_button(){if(this.get_selected_gateway_id()===this.args.gateway_id&&!this.has_payment_nonce()){$("#place_order").hide()}else{$("#place_order").show()}}}window.WC_Square_Cash_App_Pay_Handler=WC_Square_Cash_App_Pay_Handler});
